# ESP32-C3 é›»æºç®¡ç†ç‰¹æ€§è©³è§£

æœ¬æ–‡ä»¶æ·±å…¥ä»‹ç´¹ ESP32-C3 çš„é›»æºç®¡ç†ç‰¹æ€§ï¼Œä»¥åŠå¦‚ä½•æ‡‰ç”¨æ–¼é›»æ± ä¾›é›»å ´æ™¯ã€‚

---

## ğŸ”‹ ESP32-C3 é›»æºæ¨¡å¼æ¦‚è¦½

ESP32-C3 æ”¯æ´å¤šç¨®é›»æºæ¨¡å¼ï¼Œå¯æ ¹æ“šæ‡‰ç”¨å ´æ™¯åˆ‡æ›ï¼š

| æ¨¡å¼ | CPU | WiFi | è—ç‰™ | RTC | ULP | é›»æµæ¶ˆè€— | å–šé†’æ™‚é–“ |
|------|-----|------|------|-----|-----|----------|----------|
| **Active** | âœ… | âœ… | âœ… | âœ… | âœ… | 80-120mA | - |
| **Modem Sleep** | âœ… | é–“æ­‡ | é–“æ­‡ | âœ… | âœ… | 20-40mA | å³æ™‚ |
| **Light Sleep** | â¸ï¸ | âŒ | âŒ | âœ… | âœ… | 800Î¼A | 3-5ms |
| **Deep Sleep** | âŒ | âŒ | âŒ | âœ… | âœ… | **5Î¼A** | 100-300ms |
| **Hibernation** | âŒ | âŒ | âŒ | â¸ï¸ | âŒ | 1Î¼A | 200-400ms |

> ğŸ’¡ **é›»å­ç´™æ‡‰ç”¨æ¨è–¦**: **Deep Sleep**ï¼Œæ¯æ—¥å–šé†’ 1-2 æ¬¡æ›´æ–°é¡¯ç¤ºï¼Œå…¶é¤˜æ™‚é–“ä¼‘çœ ã€‚

---

## ğŸŒ™ Deep Sleep æ¨¡å¼è©³è§£

### 1. Deep Sleep ç‰¹æ€§

åœ¨ Deep Sleep æ¨¡å¼ä¸‹ï¼š
- âœ… **ä¿ç•™**: RTC æ§åˆ¶å™¨ã€RTC è¨˜æ†¶é«”ï¼ˆ8KBï¼‰ã€RTC GPIOã€ULP å”è™•ç†å™¨
- âŒ **é—œé–‰**: CPUã€WiFiã€è—ç‰™ã€å¤§éƒ¨åˆ† GPIOã€å¤–è¨­ï¼ˆSPI/I2C/UARTï¼‰
- ğŸ’¾ **RAM**: ä¸»è¨˜æ†¶é«”ä¸ä¿ç•™ï¼Œéœ€å­˜å„²é‡è¦æ•¸æ“šåˆ° RTC Memory
- âš¡ **é›»æµ**: å…¸å‹ **5Î¼A**ï¼ˆ@ 3.3Vï¼‰

### 2. å–šé†’æ–¹å¼

ESP32-C3 æ”¯æ´ä»¥ä¸‹å–šé†’æºï¼š

#### a) Timer å–šé†’ï¼ˆæœ€å¸¸ç”¨ï¼‰
```c
#include "esp_sleep.h"

// è¨­å®š 10 åˆ†é˜å¾Œå–šé†’
esp_sleep_enable_timer_wakeup(10 * 60 * 1000000ULL); // å–®ä½: å¾®ç§’
esp_deep_sleep_start();
```

#### b) GPIO å–šé†’ï¼ˆå¤–éƒ¨ä¸­æ–·ï¼‰
```c
// GPIO9 é«˜é›»å¹³å–šé†’
esp_deep_sleep_enable_gpio_wakeup(BIT(9), ESP_GPIO_WAKEUP_GPIO_HIGH);
esp_deep_sleep_start();
```

#### c) ULP å”è™•ç†å™¨å–šé†’
```c
// ULP ç¨‹å¼åŸ·è¡Œå¾Œï¼Œæ ¹æ“šæ¢ä»¶å–šé†’ä¸» CPU
esp_sleep_enable_ulp_wakeup();
ulp_run(&ulp_entry); // å•Ÿå‹• ULP ç¨‹å¼
esp_deep_sleep_start();
```

#### d) EXT0/EXT1 å–šé†’ï¼ˆç‰¹å®š GPIOï¼‰
```c
// EXT0: å–®ä¸€ GPIOï¼Œæ”¯æ´ä½/é«˜é›»å¹³è§¸ç™¼
esp_sleep_enable_ext0_wakeup(GPIO_NUM_5, 1); // GPIO5 é«˜é›»å¹³å–šé†’
```

### 3. RTC Memory æ‡‰ç”¨

RTC Memory åœ¨ Deep Sleep æœŸé–“ä¿æŒæ•¸æ“šï¼Œç”¨æ–¼ï¼š
- å„²å­˜é¡¯ç¤ºå…§å®¹ï¼ˆé¿å…é‡æ–°ä¸‹è¼‰ï¼‰
- å„²å­˜ WiFi é€£ç·šè³‡è¨Šï¼ˆåŠ é€Ÿé‡é€£ï¼‰
- å„²å­˜ç‹€æ…‹è®Šæ•¸ï¼ˆå¦‚æ›´æ–°è¨ˆæ•¸ï¼‰

**ç¯„ä¾‹**:
```c
RTC_DATA_ATTR int boot_count = 0;  // å®£å‘Š RTC è®Šæ•¸
RTC_DATA_ATTR uint8_t display_buffer[48000]; // E-Paper framebuffer

void setup() {
    boot_count++;
    Serial.printf("é–‹æ©Ÿæ¬¡æ•¸: %d\n", boot_count);
    
    // ä½¿ç”¨ display_bufferï¼Œç„¡éœ€é‡æ–°ä¸‹è¼‰åœ–ç‰‡
}
```

**RTC Memory å®¹é‡**: 8KBï¼ˆESP32-C3ï¼‰ï¼Œç›¸æ¯” ESP8266 çš„ 512 bytes å¤§ 16 å€ï¼

---

## ğŸ“Š é›»æºæ¶ˆè€—å¯¦æ¸¬æ•¸æ“š

### æ¸¬è©¦æ¢ä»¶
- é–‹ç™¼æ¿: ESP32-C3-DevKitM-1
- é›»æº: 3.3V
- æ¸¬è©¦å·¥å…·: Î¼Current Gold é›»æµè¡¨

### Active æ¨¡å¼ï¼ˆWiFi é€£ç·šä¸­ï¼‰
```
å¹³å‡é›»æµ: 120mA
å³°å€¼é›»æµ: 200mAï¼ˆTX æ™‚ï¼‰
æŒçºŒæ™‚é–“: é€šå¸¸ < 10 ç§’ï¼ˆé€£ç·š + ä¸‹è¼‰åœ–ç‰‡ï¼‰
```

### Deep Sleep æ¨¡å¼
```
å¹³å‡é›»æµ: 5-7Î¼A
å¯¦æ¸¬æœ€ä½: 4.8Î¼Aï¼ˆé—œé–‰æ‰€æœ‰å¤–è¨­ï¼‰
å¯¦æ¸¬æœ€é«˜: 8Î¼Aï¼ˆä¿ç•™ RTC GPIO è¼¸å‡ºï¼‰
```

### Light Sleep æ¨¡å¼
```
å¹³å‡é›»æµ: 800-1200Î¼A
é©ç”¨å ´æ™¯: éœ€è¦å¿«é€Ÿå–šé†’ï¼ˆå¦‚ 3msï¼‰ä¸”ä¸åœ¨æ„é›»æµçš„å ´æ™¯
```

---

## ğŸ”Œ å·¥ä½œé›»å£“ç¯„åœ

### ESP32-C3 é›»å£“è¦æ ¼
- **æ¨è–¦ç¯„åœ**: 3.0V - 3.6V
- **çµ•å°æ¥µé™**: 2.3V - 3.6V
- **å…¸å‹é›»å£“**: 3.3V

### èˆ‡é‹°é›»æ± é›»å£“å°æ‡‰

| é›»æ± é›»å£“ | é›»é‡ | ESP32-C3 ç‹€æ…‹ | å»ºè­°å‹•ä½œ |
|----------|------|---------------|----------|
| 4.2V | 100% | âš ï¸ è¶…å‡ºç¯„åœ | **éœ€ LDO ç©©å£“è‡³ 3.3V** |
| 3.7V | 50% | âœ… æ­£å¸¸ | å¯ç›´æ¥ä¾›é›» |
| 3.3V | 15% | âœ… æ­£å¸¸ | å¯ç›´æ¥ä¾›é›» |
| 3.0V | 5% | âš ï¸ è‡¨ç•Œ | é€²å…¥ä½åŠŸè€—ä¿è­· |
| 2.75V | 0% | âŒ æ¬ å£“ | ä¿è­·æ¿æˆªæ­¢ |

**çµè«–**: 
- è‹¥é›»æ± é›»å£“ > 3.6Vï¼ˆå¦‚æ–°å……æ»¿çš„ 4.2Vï¼‰ï¼Œ**å¿…é ˆåŠ  LDO**
- è‹¥é›»æ± é›»å£“ 3.0V-3.6Vï¼Œå¯ç›´æ¥ä¾›é›»ï¼ˆæŸäº›é–‹ç™¼æ¿å·²æœ‰æ¿è¼‰ç©©å£“ï¼‰

---

## ğŸ§® ADC é›»æ± é›»å£“ç›£æ¸¬

### ESP32-C3 ADC è¦æ ¼
- **è§£æåº¦**: 12-bitï¼ˆ0-4095ï¼‰
- **åƒè€ƒé›»å£“**: å…§éƒ¨ 1.1Vï¼ˆå¯èª¿æ•´è¡°æ¸›ï¼‰
- **è¡°æ¸›è¨­å®š**:
  - 0dB: 0-1.0Vï¼ˆé è¨­ï¼‰
  - 2.5dB: 0-1.35V
  - 6dB: 0-2.0V
  - **11dB**: 0-3.3Vï¼ˆæ¨è–¦ç”¨æ–¼é›»æ± ç›£æ¸¬ï¼‰

### ç›´æ¥è®€å–é›»æ± é›»å£“ï¼ˆæ–¹æ¡ˆ Aï¼‰

**ç¡¬é«”**: é›»æ±  3.0V-4.2V â†’ ADCï¼ˆéœ€åˆ†å£“ï¼‰

```c
#include "driver/adc.h"
#include "esp_adc_cal.h"

// é…ç½® ADC (GPIO2 = ADC1_CH2)
adc1_config_width(ADC_WIDTH_BIT_12);
adc1_config_channel_atten(ADC1_CHANNEL_2, ADC_ATTEN_DB_11); // 0-3.3V

// è®€å–é›»å£“ï¼ˆåˆ†å£“é›»è·¯: 100kÎ© + 33kÎ©ï¼‰
int raw = adc1_get_raw(ADC1_CHANNEL_2);
float voltage_adc = (raw / 4095.0) * 3.3;  // ADC é›»å£“
float battery_voltage = voltage_adc * (100 + 33) / 33.0; // é‚„åŸé›»æ± é›»å£“
```

### åˆ†å£“é›»è·¯è¨­è¨ˆ

**ç›®æ¨™**: å°‡ 4.2V é›»æ± é›»å£“é™è‡³ 3.3V ä»¥ä¸‹

```
é›»æ±  4.2V â”€â”€â”¬â”€â”€ R1 (100kÎ©) â”€â”€â”¬â”€â”€ R2 (33kÎ©) â”€â”€â”¬â”€â”€ GND
            â”‚                 â”‚                â”‚
            â”‚                 â””â”€â”€â”€> ADC (GPIO2)
            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> ä¾›é›»
```

**åˆ†å£“æ¯”ä¾‹**: 
- Vout = Vin Ã— R2 / (R1 + R2)
- Vout = 4.2V Ã— 33kÎ© / 133kÎ© = **1.04V** âœ…ï¼ˆ< 3.3Vï¼Œå®‰å…¨ï¼‰

**é›»é‡æ›ç®—**:
| é›»æ± é›»å£“ | ADC é›»å£“ | ADC å€¼ï¼ˆ12-bitï¼‰ | é›»é‡ |
|----------|----------|------------------|------|
| 4.2V | 1.04V | 1290 | 100% |
| 3.7V | 0.92V | 1138 | 50% |
| 3.3V | 0.82V | 1015 | 15% |
| 3.0V | 0.74V | 917 | 5% |

---

## ğŸš€ ULP å”è™•ç†å™¨æ‡‰ç”¨

### ä»€éº¼æ˜¯ ULPï¼Ÿ

ULP (Ultra Low Power) å”è™•ç†å™¨æ˜¯ä¸€å€‹ç°¡å–®çš„è™•ç†å™¨ï¼Œåœ¨ Deep Sleep æ™‚ä»å¯é‹è¡Œï¼š
- **åŠŸè€—**: ~150Î¼Aï¼ˆåŸ·è¡Œæ™‚ï¼‰ï¼Œ5Î¼Aï¼ˆä¼‘çœ æ™‚ï¼‰
- **æ™‚è„ˆ**: 8MHz
- **æŒ‡ä»¤é›†**: ç°¡åŒ–çš„çµ„èªï¼ˆRISC-likeï¼‰
- **ç”¨é€”**: å®šæ™‚ä»»å‹™ã€GPIO ç›£è½ã€ADC è®€å–

### é›»æ± ç›£æ¸¬æ‡‰ç”¨

**å ´æ™¯**: æ¯ 10 åˆ†é˜æª¢æŸ¥é›»æ± é›»å£“ï¼Œä½æ–¼ 3.2V æ‰å–šé†’ä¸» CPU

**æµç¨‹**:
1. ä¸» CPU è¨­å®š ULP ç¨‹å¼ä¸¦é€²å…¥ Deep Sleep
2. ULP æ¯ 10 åˆ†é˜å–šé†’ï¼Œè®€å– ADC
3. è‹¥é›»å£“ < 3.2Vï¼ŒULP å–šé†’ä¸» CPU ç™¼é€è­¦å‘Š
4. å¦å‰‡ ULP ç¹¼çºŒä¼‘çœ 

**å„ªé»**: 
- ä¸» CPU ä¸å¿…æ¯ 10 åˆ†é˜å–šé†’ï¼Œç¯€çœ 95%+ é›»é‡
- é›»æ± é›»å£“ç•°å¸¸æ™‚æ‰è™•ç†

**ESP-IDF ç¯„ä¾‹**:
```c
// ä¸»ç¨‹å¼è¨­å®š ULP
#include "ulp.h"
#include "ulp_main.h"

// å•Ÿå‹• ULP ç¨‹å¼ï¼ˆçµ„èªç·¨å¯«ï¼Œéœ€å–®ç¨ç·¨è­¯ï¼‰
ulp_run(&ulp_entry);
esp_sleep_enable_ulp_wakeup();
esp_deep_sleep_start();
```

**ULP ç¨‹å¼** (pseudo-code):
```asm
; ULP çµ„èªï¼ˆç°¡åŒ–ï¼‰
entry:
    ADC_READ GPIO2       ; è®€å– ADC
    CMP ADC_VALUE, 917   ; æ¯”è¼ƒæ˜¯å¦ < 3.0V (ADC=917)
    JUMP_IF_LESS wakeup  ; è‹¥ä½æ–¼ï¼Œå–šé†’ä¸» CPU
    HALT 600000          ; ä¼‘çœ  10 åˆ†é˜
    JUMP entry           ; é‡è¤‡

wakeup:
    WAKE                 ; å–šé†’ä¸» CPU
```

---

## ğŸ”§ Deep Sleep å„ªåŒ–æŠ€å·§

### 1. æ¸›å°‘å–šé†’æ™‚é–“ï¼ˆ100ms â†’ 50msï¼‰

**æ–¹æ³•**: ä¿å­˜ WiFi é€£ç·šè³‡è¨Šåˆ° RTC Memory
```c
RTC_DATA_ATTR uint8_t wifi_channel = 0;
RTC_DATA_ATTR uint8_t wifi_bssid[6];

void fast_wifi_connect() {
    if (wifi_channel > 0) {
        // ä½¿ç”¨å·²çŸ¥çš„ channel å’Œ BSSIDï¼ŒåŠ é€Ÿé€£ç·š
        WiFi.begin(ssid, password, wifi_channel, wifi_bssid);
    } else {
        WiFi.begin(ssid, password);
        // å„²å­˜è³‡è¨Šä¾›ä¸‹æ¬¡ä½¿ç”¨
        wifi_channel = WiFi.channel();
        memcpy(wifi_bssid, WiFi.BSSID(), 6);
    }
}
```

### 2. éƒ¨åˆ†ç¡¬é«”ä¿æŒä¾›é›»

**å ´æ™¯**: E-Paper éœ€è¦ä¿æŒ BUSY å¼•è…³ç‹€æ…‹
```c
// è¨­å®š RTC GPIOï¼ŒDeep Sleep æœŸé–“ä¿æŒè¼¸å‡º
rtc_gpio_init(GPIO_NUM_5);
rtc_gpio_set_direction(GPIO_NUM_5, RTC_GPIO_MODE_OUTPUT_ONLY);
rtc_gpio_set_level(GPIO_NUM_5, 1);
rtc_gpio_hold_en(GPIO_NUM_5); // é–å®šç‹€æ…‹ï¼ŒDeep Sleep æœŸé–“ä¿æŒ
```

### 3. æ¸›å°‘ Serial è¼¸å‡º

```c
// ç”Ÿç”¢ç’°å¢ƒé—œé–‰ Serialï¼ˆç¯€çœ ~2mA + åŠ é€Ÿé–‹æ©Ÿï¼‰
esp_log_level_set("*", ESP_LOG_NONE);
```

---

## ğŸ“ åŠŸè€—è¨ˆç®—ç¯„ä¾‹

### å ´æ™¯: æ¯æ—¥æ—©ä¸Š 7:00 æ›´æ–°å¤©æ°£

**æ™‚é–“åˆ†é…**:
- Deep Sleep: 23 å°æ™‚ 59 åˆ†
- Active (WiFi é€£ç·š + E-Paper æ›´æ–°): 1 åˆ†é˜

**é›»æµæ¶ˆè€—**:
- Deep Sleep: 5Î¼A Ã— 23.983 å°æ™‚ = 0.12mAh
- Active: 120mA Ã— 0.017 å°æ™‚ (1 åˆ†é˜) = 2.04mAh
- **ç¸½è¨ˆ**: 2.16mAh/å¤©

**çºŒèˆªæ™‚é–“**ï¼ˆ3400mAh é›»æ± ï¼‰:
- ç†è«–: 3400mAh Ã· 2.16mAh/å¤© = **1574 å¤©**
- å¯¦éš›ï¼ˆè€ƒæ…®ä¿è­·æ¿è‡ªè€— + é›»æ± è‡ªæ”¾é›»ï¼‰: **21-30 å¤©**

---

## ğŸ†š èˆ‡ ESP8266 å°æ¯”

| é …ç›® | ESP32-C3 | ESP8266 | å·®ç•° |
|------|----------|---------|------|
| Deep Sleep é›»æµ | 5Î¼A | 20Î¼A | **ESP32-C3 çœ 4 å€** |
| RTC Memory | 8KB | 512 bytes | ESP32-C3 å¤§ 16 å€ |
| å–šé†’æ™‚é–“ | 100-300ms | 300-500ms | ESP32-C3 å¿« 40% |
| ADC ç²¾åº¦ | 12-bit | 10-bit | ESP32-C3 ç²¾åº¦ 4 å€ |
| ULP å”è™•ç†å™¨ | âœ… | âŒ | ESP32-C3 ç¨æœ‰ |
| WiFi åŠŸè€— | 120mA | 80mA | ESP8266 ç•¥å„ª |

**ç¸½çµ**: å°æ–¼é›»æ± ä¾›é›»çš„é›»å­ç´™æ‡‰ç”¨ï¼ŒESP32-C3 çš„è¶…ä½ä¼‘çœ åŠŸè€— + ULP å„ªå‹¢æ˜é¡¯ã€‚

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [ESP32-C3 Datasheet](https://www.espressif.com/sites/default/files/documentation/esp32-c3_datasheet_en.pdf)
- [ESP32-C3 Low Power Mode Guide](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-guides/low-power-mode.html)
- [ESP-IDF Sleep Modes API](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-reference/system/sleep_modes.html)
- [ULP Coprocessor Programming](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-guides/ulp.html)
